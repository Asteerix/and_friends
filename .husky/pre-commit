#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# VÃ©rifier la prÃ©sence de fichiers sensibles
echo "ğŸ” VÃ©rification des fichiers sensibles..."

# Liste des fichiers qui ne doivent jamais Ãªtre commitÃ©s
FORBIDDEN_FILES=(
  ".env"
  ".env.local"
  ".env.production"
  ".env.development"
  "ios/.xcode.env"
)

# VÃ©rifier chaque fichier
for file in "${FORBIDDEN_FILES[@]}"; do
  if git diff --cached --name-only | grep -q "^$file$"; then
    echo "âŒ ERREUR: Tentative de commit du fichier sensible: $file"
    echo "ğŸ“ Utilisez 'git rm --cached $file' pour le retirer du commit"
    exit 1
  fi
done

# VÃ©rifier la prÃ©sence de secrets dans le code
echo "ğŸ” Recherche de secrets potentiels..."

# Patterns de secrets Ã  dÃ©tecter
SECRET_PATTERNS=(
  "SUPABASE_SERVICE_ROLE_KEY"
  "supabase_service_role_key"
  "service_role_key"
  "eyJhbGciOiJ"  # DÃ©but d'un JWT
  "sk_live_"     # Stripe secret key
  "sk_test_"     # Stripe test key
  "\+33612345678" # NumÃ©ro de test
  "123456"       # Code OTP de test
)

# VÃ©rifier les fichiers modifiÃ©s
for pattern in "${SECRET_PATTERNS[@]}"; do
  if git diff --cached --name-only -z | xargs -0 grep -l "$pattern" 2>/dev/null; then
    echo "âŒ ERREUR: Secret potentiel dÃ©tectÃ©: $pattern"
    echo "ğŸ“ VÃ©rifiez vos fichiers avant de commiter"
    exit 1
  fi
done

echo "âœ… Aucun fichier sensible ou secret dÃ©tectÃ©"

# Optionnel: ExÃ©cuter les tests
# npm test

# Optionnel: VÃ©rifier le linting
# npm run lint

exit 0